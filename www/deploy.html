<ons-page id="page1">
    <ons-toolbar>
        <div class="center">受付</div>
    </ons-toolbar>
    <div class="item">
        <h2>患者情報</h2>
        <h3>以下の内容を確認した上でデプロイを行う</h3>
        <!--<h3><span class=".itemTitle7">項目1：</span></h3>-->                          
        <ul id="patientItem"></ul> 
        <ons-input id="passportCountry" placeholder="パスポート発行国（3文字）" modifier="underbar" style="margin-bottom: 30px; margin-right:10px;"></ons-input><ons-input id="passportNo" placeholder="パスポート番号" modifier="underbar" style="margin-bottom: 30px;"></ons-input>
    </div>

    <ons-row>
        <ons-col width="50%" style="text-align: center;"><ons-button id="readQRCodeButton" modifier="outline" onclick="readPatientDataFromQR()" style="width:95%;"><ons-icon icon="fa-qrcode"></ons-icon> 患者情報の読み込み</ons-button></ons-col>
        <ons-col width="50%" style="text-align: center;"><ons-button id="deployButton" modifier="outline" onclick="deploy()" disabled="true" style="width:95%;"><ons-icon icon="fa-cloud-upload-alt"></ons-icon> スマートコントラクトのデプロイ</ons-button></ons-col>
    </ons-row>

<script>

let patientData;
let patientSignature;
let patientPassPhrase;

let tabbar = document.querySelector("ons-tabbar"); 

// イベントのキャッチ設定
hospitalContractInstance.events.StartExamination({}, function(error, event){
    let contractAddress = event.returnValues.contractAddress;
    let hospitalAddress = event.returnValues.hospitalAddress;
    let patientAddress  = event.returnValues.patientAddress; 
    if(hospitalAddress == myAddress){
            examinationContractInstance.options.address = contractAddress;
            $("#patientItem").empty();
            hideModal();
            // 遷移の挙動管理のためビジーウェイト
            let startMsec = new Date();
            while (new Date() - startMsec < 500);
            tabbar.setActiveTab(1);
            startMsec = new Date();
            while (new Date() - startMsec < 500);
            pushPage2('./detail.html'); 
    }
});

// QRコード読み込んで患者データを表示
function readPatientDataFromQR() {
    cordova.plugins.barcodeScanner.scan(function (result) {
        // キャンセルボタンを押したときの挙動は正常なのでここが呼ばれる→if文で返す
        if(result.text == "") return;
        const sourceArray = result.text.split(',');
        const key = sourceArray[0];
        const crypto = sourceArray[1];
        const sign = sourceArray[2]; 
        // 復号化
        const decrypted = CryptoJS.AES.decrypt(crypto, key);
        const decryptedStrings = decrypted.toString(CryptoJS.enc.Utf8);
        const patientDataJson = JSON.parse(decryptedStrings);
        $("#patientItem").empty(); 
        for(let key in patientDataJson) {
            $("#patientItem").append("<li>" + key + "：" + patientDataJson[key] + "</li>");
        }
        patientData = crypto;
        patientPassPhrase = key;
        patientSignature = sign;
        // デプロイボタンを押せるようにする
        $("#deployButton")[0].disabled = false;
    },function (error) {console.log(error);}); 
} 

// 患者ごとに専用のスマートコントラクトをデプロイ
async function deploy() {
    showModal("データを送信中"); 
    passportInfo = $("#passportCountry").val() + $("#passportNo").val();
    console.log(passportInfo);
    // パスポート番号の暗号化（病院固有の鍵）
    let encryptedPassportInfo = CryptoJS.AES.encrypt(passportInfo, myPassPhrase).toString();
    let encryptedPatientPassPhrase = CryptoJS.AES.encrypt(patientPassPhrase, myPassPhrase).toString();
    // トランザクションのデータ部にくっつけるバイトコードを生成
    const encodedABI = hospitalContractInstance.methods.startExamination(encryptedPassportInfo, patientData, patientSignature, encryptedPatientPassPhrase).encodeABI();
    
    // gasの使用量を計算
    let gasAmount = await hospitalContractInstance.methods.startExamination(encryptedPassportInfo, patientData, patientSignature, encryptedPatientPassPhrase).estimateGas();
    gasAmount = gasAmount + 500000;
    // トランザクションにローカルの秘密鍵で署名
    let signedtx = await web3.eth.accounts.signTransaction({to: HospitalContractAddress, data: encodedABI, gas: gasAmount}, myPrivateKey);
    // 署名済みトランザクションを送信
    let receipt = await web3.eth.sendSignedTransaction(signedtx.rawTransaction);
};
</script>
</ons-page>